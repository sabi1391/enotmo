user  nginx;
worker_processes  auto;
error_log /opt/nginx/logs/error.log;
pid        /var/run/nginx.pid;

worker_rlimit_nofile 50000;
load_module modules/ngx_http_headers_more_filter_module.so;
events {
    worker_connections  2048;
    multi_accept on;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /opt/nginx/logs/access.log  main;

upstream epmsloads {

    server 172.31.24.192:6111;

}


    sendfile        on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout           35;
    client_body_buffer_size     128k;
    chunked_transfer_encoding   on;
    client_header_buffer_size   1k;
    client_max_body_size        50m;
    large_client_header_buffers 4 4k;
    output_buffers              1 32k;
    client_body_timeout   30;
    client_header_timeout 30;
    send_timeout          30;

    open_file_cache max=1000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 5;
    open_file_cache_errors off;

    gzip  on;
    gzip_http_version 1.1;
    gzip_vary on;
    gzip_comp_level 4;
    gzip_proxied any;
    gzip_types text/html text/plain text/css application/json application/xml application/xml+rss application/x-javascript text/javascript application/javascript text/x-js;
    gzip_buffers 16 8k;
    gzip_disable "msie6";

    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=kpi_cache:10m inactive=60m max_size=1000m;
    server_tokens off;
    more_set_headers 'Server: Entomo';

        server {
                listen         80;
                return 301 https://$host$request_uri/home;
        }

    server {
                listen  443 ssl http2;
                ssl_stapling on;
                ssl_certificate /opt/nginx/conf/entomo_ssl/entomo_bundle.crt;
                ssl_certificate_key /opt/nginx/conf/entomo_ssl/entomo_private.key;
#               ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
                #ssl_protocols TLSv1.3;
                ssl_prefer_server_ciphers on;
                #ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH+EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5';
                ssl_protocols       TLSv1.2 TLSv1.3;
                ssl_ciphers    TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_CCM_8_SHA256:TLS_AES_128_CCM_SHA256:ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
                ssl_session_cache shared:SSL:10m;
                ssl_session_timeout 5m;
                ssl_buffer_size 4k;
                large_client_header_buffers 4 16k;
                http2_max_field_size 16k;
                http2_max_header_size 32k;
                server_name usuat.entomo.co
                add_header Allow "GET, POST, HEAD, PUT, DELETE " always;
                if ( $request_method !~ ^(GET|POST|HEAD|PUT|DELETE)$ ) {
                        return 405;
                }
location / {
            return 301 https://$host$request_uri/home;
        }


        location /epms {
                proxy_buffers 16 8k;
                proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_pass http://172.31.24.192:7201;
                proxy_read_timeout 300s;
                add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
        }
       location /admin {
                alias /opt/skylark/admin;
                add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
                add_header fox "admin";
                add_header X-XSS-Protection "1; mode=block" always;
                add_header X-Content-Type-Options nosniff always;
                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header Cache-Control "no-store, no-cache";
        }
        location /home {
                alias /opt/skylark/home;
                add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
                add_header fox "home";
                add_header X-XSS-Protection "1; mode=block" always;
                add_header X-Content-Type-Options nosniff always;
                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header Cache-Control "no-store, no-cache";
        }



location /home/assets/js/.*\.(jpg|jpeg|gif|css|png|js|ico|html|txt|svg|woff2|gif|ttf)$
{
alias /opt/skylark/home/assests/js;

}

location /admin/assets/js/.*\.(jpg|jpeg|gif|css|png|js|ico|html|txt|svg|woff2|gif|ttf)$
{
alias /opt/skylark/admin/assests/js;

}

location ~ ^/(home|admin)/assets/js/.*\.(json)$
{
deny all;

}
        location /epms/v1/webAdmin {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_pass http://172.31.24.192:7202;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
        }

        location /epms/v1/bi {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_pass http://172.31.24.192:7203;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
        }


        location /epms/v1/ads {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_pass http://172.31.24.192:7203;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
        }
        location /epms/v1/thumbnail {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_pass http://172.31.24.192:7203;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
        }

        location /epms/v1/tc {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_pass http://172.31.24.192:7203;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
        }
        location /epms/v1/biAdmin {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_pass http://172.31.24.192:7203;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
        }
        location /epms/v1/mobileApp/bi/thumbnail {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_pass http://172.31.24.192:7203;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
        }

        location /epms/v1/mobileApp/thumbnail {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_pass http://172.31.24.192:7203;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
        }

        location /epms/v1/mobileApp/ads/dimension {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                proxy_pass http://172.31.24.192:7203;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
        }



        location = /50x.html {
        }

    }
#######################testing##################################################
        server {
                listen         80;
                return 301 https://$host$request_uri/home;
        }

    server {
                listen  443 ssl http2;
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
                ssl_stapling on;
                ssl_certificate /opt/nginx/conf/test/newssl/bundle.crt;
                ssl_certificate_key /opt/nginx/conf/test/newssl/kpisoft_private.key;
                #ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
                #ssl_prefer_server_ciphers on;
                #ssl_ciphers 'EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH+EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5';
                ssl_protocols       TLSv1.2 TLSv1.3;
                ssl_ciphers         TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:TLS_AES_128_CCM_8_SHA256:TLS_AES_128_CCM_SHA256:ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
                ssl_prefer_server_ciphers on;

ssl_session_cache shared:SSL:10m;
                ssl_session_timeout 5m;
                ssl_buffer_size 4k;
                large_client_header_buffers 4 16k;
                http2_max_field_size 16k;
                http2_max_header_size 32k;
                server_name mastercard.kpisoft.com uscloud.kpisoft.com;
                add_header Allow "GET, POST, HEAD, PUT, DELETE " always;
                if ( $request_method !~ ^(GET|POST|HEAD|PUT|DELETE)$ ) {
                        return 405;
                }
location / {
            return 301 https://$host$request_uri/home;
        }


        location /epms {
                proxy_buffers 16 8k;
                proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;

                proxy_pass http://172.31.16.181:8111;
                proxy_read_timeout 300s;
                #add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        }
       location /admin {
                alias /opt/skylark/test/uscloud/admin;
                #add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
                add_header fox "admin";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        }
        location /home {
                alias /opt/skylark/test/uscloud/home;
                #add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
                add_header fox "home";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        }
location /home/assets/js/.*\.(jpg|jpeg|gif|css|png|js|ico|html|txt|svg|woff2|gif|ttf)$
{
alias /opt/skylark/test/uscloud/home/assests/js;

}

location /admin/assets/js/.*\.(jpg|jpeg|gif|css|png|js|ico|html|txt|svg|woff2|gif|ttf)$
{
alias /opt/skylark/test/uscloud/admin/assests/js;

}

location ~ ^/(home|admin)/assets/js/.*\.(json)$
{
deny all;
}

        location /epms/v1/webAdmin {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;

                proxy_pass http://172.31.16.181:8112;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        }

        location /epms/v1/bi {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;

                proxy_pass http://172.31.16.181:8111;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        }


        location /epms/v1/ads {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;

                proxy_pass http://172.31.16.181:8111;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        }
        location /epms/v1/thumbnail {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;

                proxy_pass http://172.31.16.181:8111;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        }

        location /epms/v1/tc {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                #proxy_pass http://172.31.10.129:8113;
                #proxy_pass http://172.31.7.235:8113;
                proxy_pass http://172.31.16.181:8111;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        }
        location /epms/v1/biAdmin {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;

                proxy_pass http://172.31.16.181:8111;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        }
        location /epms/v1/mobileApp/bi/thumbnail {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;

                proxy_pass http://172.31.16.181:8111;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        }

        location /epms/v1/mobileApp/thumbnail {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;

                proxy_pass http://172.31.16.181:8111;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        }

        location /epms/v1/mobileApp/ads/dimension {
                proxy_buffers 16 8k;
               proxy_buffer_size 16k;
                proxy_busy_buffers_size 16k;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;

                proxy_pass http://172.31.16.181:8111;
                proxy_read_timeout 300s;
                add_header fox "epms";
                add_header X-XSS-Protection "1; mode=block";
                add_header X-Content-Type-Options nosniff ;
                add_header X-Frame-Options "SAMEORIGIN";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        }



        location = /50x.html {
        }

    }


######################################################################################################
}

